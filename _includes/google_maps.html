<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grand Canyon Points of Interest</title>
    <style>
        #map {
            height: 500px; 
        }
    </style>
</head>
<body>
    <h1>Grand Canyon Points of Interest</h1>

    <div id="map"></div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyALCBEmY4lxg_h-YsAU1_tX44hoOz9-6D4&callback=initMap" async defer></script>

    <script>
        let map;
        let markers = [];
        let infoWindow;

        function initMap() {
            const grandCanyon = { lat: 36.1069, lng: -112.1129 };

            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: grandCanyon,
            });

            infoWindow = new google.maps.InfoWindow();

            // Fetch saved locations from the backend and add them to the map
            fetchSavedLocations();

            // Add click event to place a new marker and save it to the backend
            map.addListener("click", function(event) {
                placeMarker(event.latLng);
            });
        }

        function placeMarker(location) {
            const marker = new google.maps.Marker({
                position: location,
                map: map,
            });

            markers.push(marker);

            const latLng = location.lat() + ", " + location.lng();
            const infowindow = new google.maps.InfoWindow({
                content: `
                    <h3>New Location</h3>
                    <p style="color: black;">Latitude: ${location.lat().toFixed(5)}, Longitude: ${location.lng().toFixed(5)}</p>
                    <button onclick="saveLocationToBackend(${location.lat().toFixed(5)}, ${location.lng().toFixed(5)})">Save Location</button>
                `,
            });
            infowindow.open(map, marker);
        }

        // Function to save location to backend
        async function saveLocationToBackend(lat, lng) {
            try {
                const response = await fetch("http://127.0.0.1:5001/frostbyte_frontend/api/save-location", { 
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        lat: lat,
                        lng: lng,
                    }),
                });

                if (!response.ok) {
                    throw new Error("Failed to save location");
                }

                alert("Location saved successfully!");
            } catch (error) {
                console.error("Error saving location:", error);
            }
        }

        // Fetch and display saved locations from the backend
        async function fetchSavedLocations() {
            try {
                const response = await fetch("http://127.0.0.1:5001/frostbyte_frontend/api/get-locations");
                if (!response.ok) {
                    throw new Error("Failed to fetch locations");
                }

                const data = await response.json();

                data.locations.forEach(location => {
                    const marker = new google.maps.Marker({
                        position: { lat: location.lat, lng: location.lng },
                        map: map,
                        title: "Saved Location",
                    });

                    const infowindow = new google.maps.InfoWindow({
                        content: `
                            <h3>Saved Location</h3>
                            <p>Latitude: ${location.lat}, Longitude: ${location.lng}</p>
                            <button onclick="deleteLocation(${location.id})">Delete</button>
                            <button onclick="updateLocation(${location.id})">Update</button>
                        `,
                    });

                    marker.addListener("click", function() {
                        infowindow.open(map, marker);
                    });
                });
            } catch (error) {
                console.error("Error fetching locations:", error);
            }
        }

        // Delete a location
        async function deleteLocation(locationId) {
            try {
                const response = await fetch(`http://127.0.0.1:5001/frostbyte_frontend/api/delete-location/${locationId}`, {
                    method: "DELETE",
                });

                if (!response.ok) {
                    throw new Error("Failed to delete location");
                }

                alert("Location deleted successfully!");

                // Optionally, you can remove the marker from the map
                markers = markers.filter(marker => marker.id !== locationId); // Update the markers array
            } catch (error) {
                console.error("Error deleting location:", error);
            }
        }

        // Update a location (show a simple edit prompt)
        async function updateLocation(locationId) {
            const newLat = prompt("Enter new latitude:");
            const newLng = prompt("Enter new longitude:");

            if (newLat && newLng) {
                try {
                    const response = await fetch(`http://127.0.0.1:5001/frostbyte_frontend/api/update-location/${locationId}`, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            lat: newLat,
                            lng: newLng,
                        }),
                    });

                    if (!response.ok) {
                        throw new Error("Failed to update location");
                    }

                    alert("Location updated successfully!");
                } catch (error) {
                    console.error("Error updating location:", error);
                }
            }
        }
    </script>
</body>
</html>
