<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grand Canyon Points of Interest</title>
    <style>
        #map { height: 500px; }
        .delete-button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Grand Canyon Points of Interest</h1>
    <div id="map"></div>

    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap" async defer></script>

    <script>
        const API_URL = "http://127.0.0.1:8102/api";
        const AUTH_TOKEN = "YOUR_JWT_TOKEN";  // Replace with actual JWT token

        let map;
        let markers = [];

        function initMap() {
            const grandCanyon = { lat: 36.1069, lng: -112.1129 };

            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: grandCanyon,
            });

            map.addListener("click", function(event) {
                placeMarker(event.latLng);
            });

            fetchSavedLocations();
        }

        function placeMarker(location) {
            const marker = new google.maps.Marker({
                position: location,
                map: map,
            });

            const lat = location.lat();
            const lng = location.lng();

            const infowindow = new google.maps.InfoWindow({
                content: `
                    <h3 style="color: black;">New Location</h3>
                    <p style="color: black;">Latitude: ${lat.toFixed(5)}, Longitude: ${lng.toFixed(5)}</p>
                    <button onclick="saveLocation(${lat}, ${lng})">Save Location</button>
                `,
            });

            infowindow.open(map, marker);
            markers.push(marker);
        }

        async function saveLocation(lat, lng) {
            try {
                const response = await fetch(`${API_URL}/location`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({
                        latitude: lat,
                        longitude: lng,
                        channel_id: 1  // Replace with actual channel_id if needed
                    }),
                });

                if (!response.ok) throw new Error("Failed to save location");

                alert("Location saved successfully!");
                fetchSavedLocations();
            } catch (error) {
                console.error("Error saving location:", error);
            }
        }

        async function fetchSavedLocations() {
            try {
                const response = await fetch(`${API_URL}/locations`, {
                    headers: { "Authorization": `Bearer ${AUTH_TOKEN}` }
                });

                if (!response.ok) throw new Error("Failed to fetch locations");

                const data = await response.json();
                markers.forEach(marker => marker.setMap(null));
                markers = [];

                data.forEach(location => {
                    const marker = new google.maps.Marker({
                        position: { lat: location.latitude, lng: location.longitude },
                        map: map,
                        title: "Saved Location",
                    });

                    const infowindow = new google.maps.InfoWindow({
                        content: `
                            <h3>Saved Location</h3>
                            <p>Latitude: ${location.latitude}, Longitude: ${location.longitude}</p>
                            <button class="delete-button" onclick="deleteLocation(${location.id}, ${marker})">üóëÔ∏è Delete</button>
                            <button onclick="updateLocation(${location.id})">Update</button>
                        `,
                    });

                    marker.addListener("click", function() {
                        infowindow.open(map, marker);
                    });

                    markers.push(marker);
                });
            } catch (error) {
                console.error("Error fetching locations:", error);
            }
        }

        async function deleteLocation(locationId, marker) {
            try {
                const response = await fetch(`${API_URL}/location/${locationId}`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${AUTH_TOKEN}` }
                });

                if (!response.ok) throw new Error("Failed to delete location");

                alert("Location deleted successfully!");
                marker.setMap(null);
                fetchSavedLocations();
            } catch (error) {
                console.error("Error deleting location:", error);
            }
        }

        async function updateLocation(locationId) {
            const newLat = parseFloat(prompt("Enter new latitude:"));
            const newLng = parseFloat(prompt("Enter new longitude:"));

            if (isNaN(newLat) || isNaN(newLng)) {
                alert("Invalid coordinates");
                return;
            }

            try {
                const response = await fetch(`${API_URL}/location/${locationId}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify({ latitude: newLat, longitude: newLng }),
                });

                if (!response.ok) throw new Error("Failed to update location");

                alert("Location updated successfully!");
                fetchSavedLocations();
            } catch (error) {
                console.error("Error updating location:", error);
            }
        }
    </script>
</body>
</html>